---
title: "`r params$doc_title`"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
runtime: shiny
css: style.css
params:
  doc_title: "Labour Force Survey: Industry Profiles"
---

```{r}
#libraries---------------
library(tidyverse)
library(DT)
library(feasts)
#load data--------------
for_tables <- read_rds(here::here("out","for_tables.rds"))
for_heatmaps <- read_rds(here::here("out","for_heatmaps.rds"))
smoothed_with_mapping <- read_rds(here::here("out","smoothed_with_mapping.rds"))
data_for_forecasts <- read_rds(here::here("out","data_for_forecasts.rds"))
forecasts <- read_rds(here::here("out","forecasts.rds"))
agg_industries_no_utilities <- c("All",unique(for_heatmaps$high)[unique(for_heatmaps$high)!="Utilities"])

#constants---------------
accuracy_large <- 100 #levels rounded to nearest hundred
accuracy_small <- .1 #percentages rounded to nearest tenth
page_titles <- c("Landing Page",
                 "Data",
                 "Heatmap of derived measures",
                 "Heatmap of smoothed data",
                 "Forecasts")
#functions---------------
source(here::here("R","functions.R"))
nav_but <- function(direction, current_page){
    if(direction=="previous"){
      if(current_page==1){
        name = tail(page_titles, n=1)
      }else{
        name = page_titles[current_page-1]
      }
    }
  if(direction == "next"){
      if(current_page == length(page_titles)){
        name = page_titles[1]
      }else{
        name = page_titles[current_page+1]
      }
    }
  name <- str_to_lower(name)%>%
      str_replace_all(" ","-")
  lab <-  str_to_title(paste(direction, "Page"))
  oc <- paste0("location.href='#section-",name,"';")
  actionButton("1", label = lab, class = "btn btn-sm btn-primary", 
            onclick = oc)
}

```

`r page_titles[1]` {data-navmenu="Table of Contents"}
=====================================
Inputs {.sidebar}
-------------------------------------

### Navigation

```{r}
nav_but(direction = "previous", current_page = 1)
nav_but(direction = "next", current_page = 1)
```

Row {data-height=600}
-------------------------------------

```{r, out.width = "125%"}
knitr::include_graphics("aest.png")#the cover image
```

Row {data-height=400}
-------------------------------------

###

<h1 class="center">`r params$doc_title`.</h1> <!-- add the title -->

<br><br>

<h3> The Labour Force Survey (LFS) is a monthly survey which measures the current state of the Canadian labour market and is used, among other things, to calculate the national, provincial, territorial and regional employment and unemployment rates. The survey results are used to make important decisions regarding job creation, education and training, retirement pensions and income support.  This dashboard provides a by industry breakdown of British Columbia's LFS data.</h3>



`r page_titles[2]`  {data-navmenu="Table of Contents"}
===========================================

### `r page_titles[2]` 

Inputs {.sidebar}
-------------------------------------

### Navigation

```{r}
nav_but(direction = "previous", current_page = 2)
nav_but(direction = "next", current_page = 2)
```

### Inputs

```{r}
selectInput(
  "industry",
  "choose an industry",
  unique(for_tables$high),
  selected =unique(for_tables$high)[1],
  multiple = FALSE
)

tbbl_to_show <- reactive({
  temp <- for_tables%>%
    filter(high==input$industry)%>%
    ungroup()%>%
    pull(data)
  
  temp[[1]]%>%
    mutate(Industry= str_replace_all(Industry, " ", "&nbsp")) #datatable strips out whitespace
})

sketch = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(class="dt-center", colspan = 2, ''),
      th(class="dt-center", colspan = 3, 'Monthly'),
      th(class="dt-center", colspan = 2, 'Year to Date',
       th(class="dt-center", colspan = 3, 'Level Change'),
       th(class="dt-center", colspan = 3, 'Percent Change'),  
       )
    ),
    tr(
      lapply(names(for_tables[[2]][[1]]), th)
    )
  )
))
```

Row 
-------------------------------------
   
###

```{r}
DT::renderDT(
  DT::datatable(tbbl_to_show(),
                container = sketch,
                escape=FALSE,
                options(list(pageLength = 100, dom='t')),
                rownames=FALSE
                )
)
```




`r page_titles[3]`  {data-navmenu="Table of Contents"}
===========================================

### `r page_titles[3]` 

Inputs {.sidebar}
-------------------------------------

### Navigation

```{r}
nav_but(direction = "previous", current_page = 3)
nav_but(direction = "next", current_page = 3)

```

### Inputs


```{r}
selectInput(
  "measure",
  "choose a measure",
  unique(for_heatmaps$name),
  selected =unique(for_heatmaps$name)[1],
  multiple = FALSE
)

selectInput(
  "agg_industry",
  "choose an industry",
  agg_industries_no_utilities,
  selected =agg_industries_no_utilities[1],
  multiple = FALSE
)

for_heat <- reactive({
  if(input$agg_industry=="All"){
    for_heatmaps%>%
      filter(medium==high)%>%
      ungroup()%>%
      select(-high, -medium, -low)%>%
      unnest(data)%>%
      group_by(name)%>%
      nest()
  }else{
    for_heatmaps%>%
      filter(high==input$agg_industry & medium != high)%>%
      ungroup()%>%
      select(-high, -medium, -low)%>%
      unnest(data)%>%
      group_by(name)%>%
      nest()
}
})

heatmap_matrix <- reactive({
  temp <- for_heat()%>%
  filter(name==input$measure)%>%
  unnest(data)%>%
  column_to_rownames("agg_level")%>%
  select(-name)
  colnames(temp) <- str_to_title(str_replace_all(colnames(temp),"_"," "))
  temp
})

hover_text <- reactive({
  if(input$measure=="Unemployment Rate"){
     heatmap_matrix()%>%
      mutate(across(everything(), ~paste0("unscaled value: ", scales::percent(., accuracy = accuracy_small))))
  }else{
    heatmap_matrix()%>%
      mutate(across(contains("percent"), ~paste0("unscaled value: ", scales::percent(., accuracy = accuracy_small))),
            across(!contains("percent"), ~paste0("unscaled value: ", scales::comma(., accuracy = accuracy_large))))
  }
})
```

Row 
-------------------------------------
   
### 

```{r}
  plotly::renderPlotly(
    heatmaply::heatmaply(heatmap_matrix(), 
                         scale="column", 
                         Colv=FALSE,
                         main= paste0("Measure: ",input$measure, ", Industry: ", input$agg_industry),
                         custom_hovertext=hover_text()))
```

`r page_titles[4]`  {data-navmenu="Table of Contents"}
===========================================

### `r page_titles[4]` 

Inputs {.sidebar}
-------------------------------------

### Navigation

```{r}
nav_but(direction = "previous", current_page = 4)
nav_but(direction = "next", current_page = 4)

```

### Inputs


```{r}
selectInput(
  "measure1",
  "choose a measure",
  unique(smoothed_with_mapping$name),
  selected =unique(smoothed_with_mapping$name)[1],
  multiple = FALSE
)

selectInput(
  "agg_industry1",
  "choose an industry",
  agg_industries_no_utilities,
  selected =agg_industries_no_utilities[1],
  multiple = FALSE
)

for_heat1 <- reactive({
  if(input$agg_industry1=="All"){
    smoothed_with_mapping%>%
      filter(medium==high)%>%
      ungroup()%>%
      select(-high, -medium, -low)%>%
      unnest(data)%>%
      group_by(name)%>%
      nest()
  }else{
    smoothed_with_mapping%>%
      filter(high==input$agg_industry1 & medium != high)%>%
      ungroup()%>%
      select(-high, -medium, -low)%>%
      unnest(data)%>%
      group_by(name)%>%
      nest()
}
})

heatmap_matrix1 <- reactive({
  temp <- for_heat1()%>%
  filter(name==input$measure1)%>%
  unnest(data)%>%
  column_to_rownames("agg_level")%>%
  select(-name)
  colnames(temp) <- str_to_title(str_replace_all(colnames(temp),"_"," "))
  temp
})

hover_text1 <- reactive({
  if(input$measure1=="Unemployment Rate"){
     heatmap_matrix1()%>%
      mutate(across(everything(), ~paste0("unscaled value: ", scales::percent(., accuracy = accuracy_small))))
  }else{
    heatmap_matrix1()%>%
      mutate(across(contains("percent"), ~paste0("unscaled value: ", scales::percent(., accuracy = accuracy_small))),
            across(!contains("percent"), ~paste0("unscaled value: ", scales::comma(., accuracy = accuracy_large))))
  }
})
```

Row 
-------------------------------------
   
### 

```{r}
plotly::renderPlotly(
  heatmaply::heatmaply(heatmap_matrix1(), 
                       scale="row", 
                       fontsize_col = 5, 
                       Colv=FALSE, 
                       main= paste0("Measure: ",input$measure1, ", Industry: ", input$agg_industry1),
                       custom_hovertext=hover_text1())
)
```




`r page_titles[5]`  {data-navmenu="Table of Contents"}
===========================================

### `r page_titles[5]` 

Inputs {.sidebar}
-------------------------------------

### Navigation

```{r}
nav_but(direction = "previous", current_page = 5)
nav_but(direction = "next", current_page = 5)
```

### Inputs

```{r}
selectInput(
  "industry2",
  "choose an industry",
  unique(forecasts$agg_level),
  selected =unique(forecasts$agg_level)[1],
  multiple = FALSE
)

```

Row 
-------------------------------------
   
###

```{r, fig.retina=2}
renderPlot(
 plot_forecasts(data_for_forecasts, forecasts, input$industry2) 
)
```







