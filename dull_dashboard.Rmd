---
title: "`r params$doc_title`"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    css: style.css
params:
  doc_title: "Dull LFS industry profiles"
---

```{r}
library(flexdashboard)
library(knitr)
library(tidyverse)
library(crosstalk)
library(DT)
library(plotly)
library(heatmaply)
source(here::here("R","functions.R"))

smoothed_with_mapping <- read_rds(here::here("out","smoothed_with_mapping.rds"))

for_ts_plots <- smoothed_with_mapping%>%  
    ungroup()%>%
  select(agg_level, name, high, low, data)%>%
  unnest(data)%>%
  pivot_longer(cols=-c(agg_level, name, high, low), names_to = "date", values_to="value")%>%
  mutate(date=lubridate::ymd(date))%>%
  ungroup()%>%
  filter(is.na(low))
shared_ts <- SharedData$new(for_ts_plots)

for_heatmaps <- smoothed_with_mapping%>%
  filter(agg_level==high)%>%
  ungroup()%>%
  select(agg_level, name, data)

for_tables <- read_rds(here::here("out","for_tables.rds"))%>%
  tidyr::unnest(data)%>%
  ungroup()%>%
  mutate(Characteristic = if_else(Characteristic=="", NA_character_, Characteristic))%>%
  fill(Characteristic, .direction = "down")%>%
  mutate(Industry= str_replace_all(Industry, " ", "&nbsp"))
Shared_table <- SharedData$new(for_tables)

for_plots <- read_rds(here::here("out","for_plots.rds"))%>%
  dplyr::rename(Characteristic=name)%>%
  tidyr::unnest(data)%>%
  ungroup()

Shared_em <- SharedData$new(for_plots%>%filter(Characteristic=="Employed"), group = "industry")
Shared_ft <- SharedData$new(for_plots%>%filter(Characteristic=="Full-Time"), group = "industry")
Shared_lf <- SharedData$new(for_plots%>%filter(Characteristic=="Labour Force"), group = "industry")
Shared_pt <- SharedData$new(for_plots%>%filter(Characteristic=="Part-Time"), group = "industry")
Shared_un <- SharedData$new(for_plots%>%filter(Characteristic=="Unemployed"), group = "industry")
Shared_ur <- SharedData$new(for_plots%>%filter(Characteristic=="Unemployment Rate"), group = "industry")

for_pca<- read_rds(here::here("out","for_pca.rds"))%>%
  mutate(biplot=map(pcs, biplot_wrapper))

page_titles <- c("Title Page",#replace with your page titles
                 "Data table",
                 "Level Changes",
                 "Percent Changes",
                 "Biplots of Employed and Unemployed",
                 "Biplots of Full time and Part time",
                 "Biplots of Labour Force and Unemployment rate",
                 "Time series plots",
                 "Heatmaps"
                 )
```

# `r page_titles[1]` {data-navmenu="Table of Contents"}


Row {data-height=600}
-------------------------------------

```{r, out.width = "150%"}
knitr::include_graphics("aest.png")#the cover image
```

Row {data-height=400}
-------------------------------------

###

<h1 class="center">`r params$doc_title`.</h1> 

<br><br>

<h3> This a non-shiny Labour Force Survey Industry Profiles dashboard... </h3>

# `r page_titles[2]` {data-navmenu="Table of Contents"}

## Inputs {.sidebar}

### Inputs:

```{r}
  filter_select(
    id = "high",
    label = "Choose an industry",
    sharedData = Shared_table,
    group = ~`high`,
    multiple = FALSE
  )

filter_select(
    id = "char",
    label = "Choose a characteristic",
    sharedData = Shared_table,
    group = ~`Characteristic`,
    multiple = FALSE
  )

```

```{js, echo=FALSE}
<!-- function filter_default(){ -->
<!--   document.getElementById("high").getElementsByClassName("selectized")[0].selectize.setValue("Construction", false)  -->
<!--   document.getElementById("char").getElementsByClassName("selectized")[0].selectize.setValue("Employed", false) -->
<!-- } -->
<!-- $(document).ready(filter_default); -->
```


## Column

### `r page_titles[2]`

```{r}
sketch = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(class="dt-center", colspan = 3, ''),
      th(class="dt-center", colspan = 3, 'Monthly'),
      th(class="dt-center", colspan = 2, 'Year to Date',
       th(class="dt-center", colspan = 3, 'Level Change'),
       th(class="dt-center", colspan = 3, 'Percent Change'),  
       )
    ),
    tr(
      lapply(names(for_tables), th)
    )
  )
))

Shared_table %>%
  DT::datatable(
    container = sketch,
    rownames = FALSE,
    escape = FALSE,
    extensions = c('Buttons', 'FixedColumns'),
    class = 'cell-border stripe',
    options = list(
    pageLength = 100,
    dom = 'Bfrtip',
    scrollX = TRUE,
    columnDefs = list(list(visible=FALSE, targets = c(0,1))),
    buttons = c('csv', 'excel')))
```


# `r page_titles[3]` {data-navmenu="Table of Contents"}

## Inputs {.sidebar}

### `r page_titles[3]`

```{r}
  filter_select(
    id = "high_plots",
    label = "Choose an industry",
    sharedData = Shared_em,
    group = ~`high`,
    multiple = FALSE
  )
```

Row {data-height=500}
-------------------------------------

### Employed

```{r}
level_change_plot(Shared_em)
```


### Full time

```{r}
level_change_plot(Shared_ft)
```

### Labour Force

```{r}
level_change_plot(Shared_lf)
```


Row {data-height=500}
-------------------------------------

### Part time

```{r}
level_change_plot(Shared_pt)
```

### Unemployed

```{r}
level_change_plot(Shared_un)
```

### Unemployment rate

```{r}
level_change_plot(Shared_ur)
```


# `r page_titles[4]` {data-navmenu="Table of Contents"}

## Inputs {.sidebar}

### `r page_titles[4]`

Row {data-height=500}
-------------------------------------

### Employed

```{r}
percent_change_plot(Shared_em)
```


### Full time

```{r}
percent_change_plot(Shared_ft)
```

### Labour Force

```{r}
percent_change_plot(Shared_lf)
```


Row {data-height=500}
-------------------------------------

### Part time

```{r}
percent_change_plot(Shared_pt)
```

### Unemployed

```{r}
percent_change_plot(Shared_un)
```

### Unemployment rate

```{r}
percent_change_plot(Shared_ur)
```

# `r page_titles[5]` {data-navmenu="Table of Contents"}

## Column

### Employed

```{r}
plt <- for_pca%>%
  filter(name=="Employed")%>%
  pull(biplot)
plt[[1]]
```

### Unemployed

```{r}
plt <- for_pca%>%
  filter(name=="Unemployed")%>%
  pull(biplot)
plt[[1]]
```


# `r page_titles[6]` {data-navmenu="Table of Contents"}

## Column

### Full time

```{r}
plt <- for_pca%>%
  filter(name=="Full-Time")%>%
  pull(biplot)
plt[[1]]
```

### Part time

```{r}
plt <- for_pca%>%
  filter(name=="Part-Time")%>%
  pull(biplot)
plt[[1]]
```


# `r page_titles[7]` {data-navmenu="Table of Contents"}


## Column

### Labour Force

```{r}
plt <- for_pca%>%
  filter(name=="Labour Force")%>%
  pull(biplot)
plt[[1]]
```

### Unemployment rate

```{r}
plt <- for_pca%>%
  filter(name=="Unemployment Rate")%>%
  pull(biplot)
plt[[1]]
```


# `r page_titles[8]` {data-navmenu="Table of Contents"}

## Inputs {.sidebar}

```{r}
  filter_select(
    id = "high_ts",
    label = "Choose an industry",
    sharedData = shared_ts,
    group = ~ high,
    multiple = FALSE
  )

filter_select(
    id = "char_ts",
    label = "Choose a characteristic",
    sharedData = shared_ts,
    group = ~ name,
    multiple = FALSE
  )

```

```{js, echo=FALSE}
function filter_default(){
  document.getElementById("high_ts").getElementsByClassName("selectized")[0].selectize.setValue("Construction", false)
  document.getElementById("char_ts").getElementsByClassName("selectized")[0].selectize.setValue("Employed", false)
}
$(document).ready(filter_default);
```

## Column

### `r page_titles[8]`

```{r}
plot_ly(shared_ts, 
        x=~date, 
        y=~value, 
        color=~agg_level, 
        type= "scatter", 
        mode="line", 
        text=~agg_level,
        hoverinfo = 'text')%>%
 # config(displayModeBar = FALSE)%>%
  layout(xaxis = list(title = ''), yaxis = list(title = ''))
```

# `r page_titles[9]` {data-navmenu="Table of Contents"}

Column {.tabset}
-------------------------------------
   
### Employed

```{r}
my_heatmap("Employed")
```   
 
### Unemployed
    
```{r}
my_heatmap("Unemployed")
```

